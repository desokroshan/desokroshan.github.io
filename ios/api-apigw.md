# API

# Overview

Add RESTful APIs handled by your serverless Lambda functions. The CLI deploys your APIs and handlers using [Amazon API Gateway](http://docs.aws.amazon.com/apigateway/latest/developerguide/) and [AWS Lambda](http://docs.aws.amazon.com/lambda/latest/dg/).

## Set Up Your Backend

1. Complete the [Get Started](./get-started) steps before you proceed.

2. Use the CLI to add api to your cloud-enabled backend and app.

 In a terminal window, navigate to your project folder (the folder that contains your app `.xcodeproj` file), and add the SDK to your app.

	```bash
	$ cd ./YOUR_PROJECT_FOLDER
	$ amplify add api
	```

3. Choose `> REST` as your API service.

4. Choose `> Create a new Lambda function`.

5. Choose the `> Serverless express function` template.

6. Restrict API access? Choose `Yes`

7. Who should have access? Choose `Authenticated and Guest users`

8. When configuration of your API is complete, the CLI displays a message confirming that you have configured local CLI metadata for this category. You can confirm this by viewing status.

    ```bash
    $ amplify status
    | Category  | Resource name   | Operation | Provider plugin   |
    | --------- | --------------- | --------- | ----------------- |
    | Function  | lambda01234567  | Create    | awscloudformation |
    | Api       | api012345678    | Create    | awscloudformation |
    ```

9. To create your backend AWS resources run:

    ```bash
    $ amplify push
    ```

   Use the steps in the next section to connect your app to your backend.

## Connect to Your Backend

Use the following steps to add Cloud Logic to your app.

1. `Podfile` that you configure to install the AWS Mobile SDK must contain:

	```ruby
	platform :ios, '9.0'

	target :'YOUR-APP-NAME' do
	  use_frameworks!

	     # For auth
	     pod 'AWSAuthCore', '~> 2.6.13'
	     pod 'AWSMobileClient', '~> 2.6.13'

	     # For API
	     pod 'AWSAPIGateway', '~> 2.6.13'

	     # other pods

	end
	```

	Run `pod install --repo-update` before you continue.

	If you encounter an error message that begins `[!] Failed to connect to GitHub to update the CocoaPods/Specs . . .`, and your internet connectivity is working, you may need to [update openssl and Ruby](https://stackoverflow.com/questions/38993527/cocoapods-failed-to-connect-to-github-to-update-the-cocoapods-specs-specs-repo/48962041#48962041).

2. Classes that call |ABP| APIs must use the following import statements:

	```
	import AWSAuthCore
	import AWSCore
	import AWSAPIGateway
	import AWSMobileClient
	```

3. Next, import files generated by CLI. The CLI generates a client code file and request-response structure file for each API you add.

4. Add those files by going to your Xcode Project Navigator project, right-click on project's name in top left corner, and select "Add Files to YOUR_APP_NAME".

5. Select all the files under :code:`generated-src` folder of your application's root folder and add them to your project.

6. Next, set the bridging header for Swift in your project settings. Double-click your project name in the Xcode Project Navigator, choose the Build Settings tab and search for  :guilabel:`Objective-C Bridging Header`. Enter :code:`generated-src/Bridging_Header.h`

	This is needed because the AWS generated code has some Objective-C code which requires bridging to be used for Swift.

	> If you already have a bridging header in your app, you can just append an extra line to it: `#import "AWSApiGatewayBridge.h"` instead of above step.

7. Use the files generated by CLI to determine the client name of your API. In the :code:`generated-src` folder, files ending with name :code:`*Client.swift` are the names of your client (without .swift extension).

	The path of the client code file is `./generated-src/YOUR_API_RESOURCE_NAME+YOUR_APP_NAME+Client.swift`.

	So, for an app named :code:`useamplify` with an API resource named `xyz123`, the path of the code file might be `./generated-src/xyz123useamplifyabcdClient.swift`. The API client name would be `xyz123useamplifyabcdClient`.

	- Find the resource name of your API by running `amplify status`.
	- Copy your API client name to use when invoking the API in the following step.


8. Invoke a Cloud Logic API.

	To invoke a Cloud Logic API, create code in the following form and substitute your API's
	client class, model, and resource paths. Replace :code:`YOUR_API_CLIENT_NAME` with the value you copied from the previous step.

	```swift
            import UIKit
            import AWSAuthCore
            import AWSCore
            import AWSAPIGateway
            import AWSMobileClient

            // ViewController or application context . . .

              func doInvokeAPI() {
                   // change the method name, or path or the query string parameters here as desired
                   let httpMethodName = "POST"
                   // change to any valid path you configured in the API
                   let URLString = "/items"
                   let queryStringParameters = ["key1":"{value1}"]
                   let headerParameters = [
                       "Content-Type": "application/json",
                       "Accept": "application/json"
                   ]

                   let httpBody = "{ \n  " +
                           "\"key1\":\"value1\", \n  " +
                           "\"key2\":\"value2\", \n  " +
                           "\"key3\":\"value3\"\n}"

                   // Construct the request object
                   let apiRequest = AWSAPIGatewayRequest(httpMethod: httpMethodName,
                           urlString: URLString,
                           queryParameters: queryStringParameters,
                           headerParameters: headerParameters,
                           httpBody: httpBody)

                  // Create a service configuration
                  let serviceConfiguration = AWSServiceConfiguration(region: AWSRegionType.USEast1,
                        credentialsProvider: AWSMobileClient.sharedInstance().getCredentialsProvider())

                  // Initialize the API client using the service configuration
                  xyz123useamplifyabcdClient.registerClient(withConfiguration: serviceConfiguration!, forKey: "CloudLogicAPIKey")

                  // Fetch the Cloud Logic client to be used for invocation
                  let invocationClient = xyz123useamplifyabcdClient.client(forKey: "CloudLogicAPIKey")

                  invocationClient.invoke(apiRequest).continueWith { (task: AWSTask) -> Any? in
                           if let error = task.error {
                               print("Error occurred: \(error)")
                               // Handle error here
                               return nil
                           }

                           // Handle successful result here
                           let result = task.result!
                           let responseString = String(data: result.responseData!, encoding: .utf8)

                           print(responseString)
                           print(result.statusCode)

                           return nil
                       }
                   }
	```
